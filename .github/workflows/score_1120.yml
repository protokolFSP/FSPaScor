name: score-1120

on:
  workflow_dispatch:
    inputs:
      max_new_files:
        description: "Max new files to process in this run"
        required: false
        default: "10"
      max_seconds:
        description: "How many seconds from the beginning to score"
        required: false
        default: "1120"
      whisper_model:
        description: "faster-whisper model (tiny/base/small/medium/large-v3)"
        required: false
        default: "medium"
      whisper_compute_type:
        description: "ctranslate2 compute type (int8/int8_float16/float16/float32)"
        required: false
        default: "int8"
      archive_item_identifier:
        description: "OPTIONAL: archive.org item identifier that contains the .m4a files (same basename as SRT)"
        required: false
        default: ""
  schedule:
    - cron: "17 3 * * *"

permissions:
  contents: write

concurrency:
  group: score-1120
  cancel-in-progress: true

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Setup Java (LanguageTool)
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Cache LanguageTool (language-tool-python)
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/language_tool_python
          key: ${{ runner.os }}-ltp-${{ hashFiles('tools/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-ltp-

      - name: Cache Whisper models
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/huggingface
            ~/.cache/whisper
            ~/.cache/ctranslate2
          key: ${{ runner.os }}-whisper-${{ github.event.inputs.whisper_model || 'medium' }}-${{ hashFiles('tools/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-whisper-

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r tools/requirements.txt

      - name: Clone transcripts repo
        run: |
          rm -rf _deps/FSPtranskript
          mkdir -p _deps
          git clone --depth 1 https://github.com/protokolFSP/FSPtranskript.git _deps/FSPtranskript

      - name: Run scoring pipeline (audio-first, SRT-guided)
        env:
          TRANSCRIPTS_DIR: _deps/FSPtranskript/transcripts
          PUBLIC_DIR: public
          MAX_SECONDS: ${{ github.event.inputs.max_seconds || '1120' }}
          MAX_NEW_FILES: ${{ github.event.inputs.max_new_files || '10' }}
          WHISPER_MODEL: ${{ github.event.inputs.whisper_model || 'medium' }}
          WHISPER_COMPUTE_TYPE: ${{ github.event.inputs.whisper_compute_type || 'int8' }}
          ARCHIVE_ITEM_IDENTIFIER: ${{ github.event.inputs.archive_item_identifier || vars.ARCHIVE_ITEM_IDENTIFIER || '' }}
        run: |
          python tools/run_1120.py

      - name: Commit & push if changed (auto-resolve generated conflicts)
        run: |
          set -euo pipefail

          FILES=(
            "public/metrics_1120.csv"
            "public/scores_1120.json"
            "public/scores_1120.full.json"
          )

          if [ -z "$(git status --porcelain)" ]; then
            echo "No changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add "${FILES[@]}"
          git commit -m "chore: update 1120s scores (audio-first)" || true

          for attempt in 1 2 3; do
            echo "Sync attempt $attempt/3"
            git fetch origin main

            if ! git rebase origin/main; then
              echo "Rebase conflict. Auto-resolving for generated outputs..."
              # In modify/delete cases the generated files are usually left in the working tree.
              # We keep the generated version (ours) deterministically.
              for f in "${FILES[@]}"; do
                if [ -f "$f" ]; then
                  git add -f "$f"
                else
                  git rm -f "$f" || true
                fi
              done

              git rebase --continue || {
                echo "Auto-resolve failed. Aborting rebase."
                git rebase --abort || true
                exit 1
              }
            fi

            if git push origin HEAD:main; then
              echo "Pushed successfully."
              exit 0
            fi

            echo "Push rejected. Retrying..."
            sleep 2
          done

          echo "Push failed after retries."
          exit 1
